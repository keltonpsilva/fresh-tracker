name: Generate Version Early

on:
  workflow_call:
    outputs:
      version:
        description: "The full version number including 'v' prefix to use for the application"
        value: ${{ jobs.generate-version-early.outputs.VERSION }}
      version-number:
        description: "The version number without the 'v' prefix to use for the application"
        value: ${{ jobs.generate-version-early.outputs.VERSION_NUMBER }}
      build-name:
        description: "The build name (version without rc suffix) to use for Flutter builds"
        value: ${{ jobs.generate-version-early.outputs.BUILD_NAME }}
      build-number:
        description: "The build number to use for Flutter builds"
        value: ${{ jobs.generate-version-early.outputs.BUILD_NUMBER }}

jobs:
  generate-version-early:
    name: Generate Version (Early)
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.generate-tag-version.outputs.VERSION }}
      VERSION_NUMBER: ${{ steps.generate-tag-version.outputs.VERSION_NUMBER }}
      BUILD_NAME: ${{ steps.generate-tag-version.outputs.BUILD_NAME }}
      BUILD_NUMBER: ${{ steps.generate-tag-version.outputs.BUILD_NUMBER }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and calculate next version
        id: generate-tag-version
        run: |
          # Fetch all tags
          git fetch --tags

          DEFAULT_TAG=1.0.0
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # If LAST_TAG is empty (no tags exist), set TAG to DEFAULT_TAG
          if [ -z "$LAST_TAG" ]; then
            TAG=$DEFAULT_TAG
          else
            TAG=$LAST_TAG
          fi

          # Compare the tags and set TAG to DEFAULT_TAG if LAST_TAG is lower
          if [ "$(printf '%s\n' "$DEFAULT_TAG" "$TAG" | sort -V | head -n 1)" = "$TAG" ] && [ "$TAG" != "$DEFAULT_TAG" ]; then
            TAG=$DEFAULT_TAG
          fi

          MAJOR_MINOR=$(echo "$TAG" | awk -F'.' '{print $1"."$2}')
          PATCH=$(echo "$TAG" | awk -F'.' '{print $3}' | awk -F'-' '{print $1}' | tr -d '[:alpha:]')

          # Check if GITHUB_REF contains 'release' 
          if [[ "$GITHUB_REF" == *release* ]]; then
            export VERSION="$MAJOR_MINOR.$PATCH"
            export BUILD_NAME="$MAJOR_MINOR.$PATCH"
            export BUILD_NUMBER="1"
          else
            # Generate Pre tag version
            if [[ "$TAG" == *-rc-* ]]; then
              # Increase Build Number
              echo "Pre tag found only increase build number by 1"

              NEXT_PATCH=$PATCH
              PREVIOUS_BUILDNUMBER=$(echo "$TAG" | awk -F'-rc-' '{print $2}' | tr -d '[:alpha:]')
              BUILDNUMBER=$((PREVIOUS_BUILDNUMBER + 1))
            else
              # Increase Path Number and Set Build number 1
              echo "Pre tag not found create new pre tag"

              NEXT_PATCH=$((PATCH + 1))
              BUILDNUMBER=1
            fi
            export VERSION="$MAJOR_MINOR.$NEXT_PATCH-rc-$BUILDNUMBER"
            export BUILD_NAME="$MAJOR_MINOR.$NEXT_PATCH"
            export BUILD_NUMBER="$BUILDNUMBER"
          fi

          # Add 'v' prefix to version for tags
          VERSION_WITH_PREFIX="v$VERSION"
          # Extract version number without 'v' prefix if present
          VERSION_NUMBER=$VERSION

          echo "Setting version to $VERSION_WITH_PREFIX"
          echo "VERSION=$VERSION_WITH_PREFIX" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
