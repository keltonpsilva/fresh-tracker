on:
  push:

# -------------------------------------------
# 1. ANALYZE & TEST
# -------------------------------------------

permissions:
  contents: write

jobs:
  analyze-and-test:
    name: Analyze & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Analyze
        run: flutter analyze --fatal-infos --fatal-warnings

      # Optional Tests
      # - name: Test
      #   run: flutter test

  # -------------------------------------------
  # 2. BUILD WEB
  # -------------------------------------------

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [analyze-and-test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release

      - name: Upload Web Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 30

  # -------------------------------------------
  # 3. BUILD ANDROID
  # -------------------------------------------

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [analyze-and-test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # -------------------------------------------
  # 4. GENERATE VERSIONING
  # -------------------------------------------

  generate-versioning:
    needs: [build-android, build-web]
    uses: ./.github/workflows/generate-versioning.yaml
    if: github.event_name == 'push' && ((github.ref == 'refs/heads/main') || startsWith(github.ref_name, 'release'))

  # -------------------------------------------
  # 5. CREATE TAG
  # -------------------------------------------

  create-tag:
    needs: [generate-versioning]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Create tag
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ needs.generate-versioning.outputs.version }}',
              sha: context.sha
            })

  # -------------------------------------------
  # 6. CREATE RELEASE
  # -------------------------------------------

  create-release:
    runs-on: ubuntu-latest
    needs: [generate-versioning, create-tag]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Web Artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web/

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-build
          path: build/android/

      - name: Create zip archive for web
        run: |
          cd build/web
          zip -r ../../web-build.zip .
          cd ../..

      - name: Create Release
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.generate-versioning.outputs.version }}';
            const fs = require('fs');
            const path = require('path');

            // Check if release already exists, if not create it
            let release;
            try {
              const existingRelease = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: version
              });
              release = existingRelease.data;
            } catch (error) {
              // Release doesn't exist, create it
              release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: version,
                name: `${version}`,
                generate_release_notes: true,
                draft: false,
                prerelease: ${{ github.ref == 'refs/heads/main' }}
              }).then(res => res.data);
            }

            // Upload web build zip
            const webBuildZip = fs.readFileSync('web-build.zip');
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              name: 'web-build.zip',
              data: webBuildZip,
              headers: {
                'content-type': 'application/zip',
                'content-length': webBuildZip.length
              }
            });

            // Upload Android APK
            const androidDir = 'build/android';
            if (fs.existsSync(androidDir)) {
              const files = fs.readdirSync(androidDir);
              const apkFile = files.find(file => file.endsWith('.apk'));
              if (apkFile) {
                const androidApkPath = path.join(androidDir, apkFile);
                const androidApk = fs.readFileSync(androidApkPath);
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id,
                  name: apkFile,
                  data: androidApk,
                  headers: {
                    'content-type': 'application/vnd.android.package-archive',
                    'content-length': androidApk.length
                  }
                });
              }
            }
